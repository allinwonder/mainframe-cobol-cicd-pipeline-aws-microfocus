---
  AWSTemplateFormatVersion: "2010-09-09"

  Description: TBA
  Parameters:
    BucketName:
      Type: String
      Description: S3 bucket name that hosts the cloudformation templates
    VPCName:
      Type: String
      Default: mainframe-cobol-cicd-aws-microfocus
    RepositoryName:
      Type: String
      Default: mainframe-cobol-cicd-aws-microfocus

  Resources:
    VPC:
      Type: AWS::CloudFormation::Stack
      Properties:
        Parameters: 
          VPCName: !Ref VPCName
        Tags:
        - Key: Solution
          Value: mainframe-cobol-cicd-aws-microfocus
        - Key: Stack
          Value: VPC
        TemplateURL: !Sub "https://${BucketName}.s3.amazonaws.com/vpc.yaml"
        TimeoutInMinutes: 15
    WindowsInstance:
      Type: AWS::CloudFormation::Stack
      Properties:
        Parameters:
          VPC: !GetAtt VPC.Outputs.VPCId
          WindowsInstanceSubnetId: !GetAtt VPC.Outputs.PrivateSubnet0
        Tags:
        - Key: Solution
          Value: mainframe-cobol-cicd-aws-microfocus
        - Key: Stack
          Value: WindowsInstance
        TemplateURL: !Sub "https://${BucketName}.s3.amazonaws.com/development-instance.yaml"
        TimeoutInMinutes: 15
    CodeRepository:
      Type: AWS::CloudFormation::Stack
      Properties:
        Parameters:
          RepositoryName: !Ref RepositoryName
        TemplateURL: !Sub "https://${BucketName}.s3.amazonaws.com/codecommit.yaml"
        TimeoutInMinutes: 15
        Tags:
        - Key: Solution
          Value: mainframe-cobol-cicd-aws-microfocus
        - Key: Stack
          Value: WindowsInstance
